<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Talentos PUZIO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #003366 0%, #0055a5 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: #003366;
        }
        .tab-button:hover {
            background: #f8f9fa;
        }
        .tab-button.active {
            background: #003366;
            color: white;
            border-bottom-color: #ff9900;
        }
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #003366;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #003366 0%, #0055a5 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .candidato-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .candidato-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            border-left: 4px solid #0055a5;
        }
        .candidato-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .candidato-nome {
            font-size: 1.2rem;
            font-weight: 600;
            color: #003366;
        }
        .score-badge {
            background: #003366;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .candidato-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .info-item {
            font-size: 0.9rem;
        }
        .info-label {
            font-weight: 600;
            color: #666;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #003366;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .candidato-info { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
        }
        .file-upload-label {
            display: block;
            padding: 12px;
            border: 2px dashed #0055a5;
            border-radius: 8px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-upload-label:hover {
            background: #f0f4ff;
            border-color: #003366;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Banco de Talentos PUZIO</h1>
            <p>Sistema de Gest√£o de Candidatos e Vagas</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCandidatos">0</div>
                <div class="stat-label">Total de Candidatos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalVagas">0</div>
                <div class="stat-label">Vagas Abertas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="candidatosHoje">0</div>
                <div class="stat-label">Candidatos Hoje</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('candidatos', this)">Cadastrar Candidato</button>
            <button class="tab-button" onclick="showTab('vagas', this)">Cadastrar Vaga</button>
            <button class="tab-button" onclick="showTab('buscar', this)">Buscar por Vaga</button>
            <button class="tab-button" onclick="showTab('resultados', this)">Todos os Candidatos</button>
        </div>

        <div id="alert-container"></div>

        <div id="candidatos" class="tab-content active">
            <h2>Cadastrar Novo Candidato</h2>
            <form id="formCandidato">
                <div class="form-row">
                    <div class="form-group"><label for="nome">Nome Completo *</label><input type="text" id="nome" name="nome" required></div>
                    <div class="form-group"><label for="telefone">Telefone *</label><input type="tel" id="telefone" name="telefone" required placeholder="(11) 99999-9999"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" name="email"></div>
                    <div class="form-group"><label for="cidade">Cidade *</label><input type="text" id="cidade" name="cidade" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="cargo_desejado">Cargo Desejado *</label><input type="text" id="cargo_desejado" name="cargo_desejado" required placeholder="Ex: Motorista, Operador de Empilhadeira"></div>
                    <div class="form-group"><label for="experiencia_anos">Experi√™ncia (anos)</label><input type="number" id="experiencia_anos" name="experiencia_anos" min="0" max="50"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="disponibilidade">Disponibilidade</label><select id="disponibilidade" name="disponibilidade"><option value="">Selecione...</option><option value="imediato">Imediato</option><option value="15 dias">15 dias</option><option value="30 dias">30 dias</option><option value="a combinar">A combinar</option></select></div>
                    <div class="form-group"><label for="skills">Habilidades/Palavras-chave</label><input type="text" id="skills" name="skills" placeholder="Ex: motorista, empilhadeira (separar por v√≠rgula)"></div>
                </div>
                <div class="form-group"><label for="observacoes">Observa√ß√µes</label><textarea id="observacoes" name="observacoes" placeholder="Informa√ß√µes adicionais..."></textarea></div>
                <div class="form-group">
                    <label for="curriculo">Curr√≠culo (PDF, DOC, DOCX - m√°x 10MB)</label>
                    <input type="file" id="curriculo" name="curriculo" accept=".pdf,.doc,.docx" style="display:none;">
                    <label for="curriculo" class="file-upload-label">Clique para selecionar o arquivo</label>
                </div>
                <button type="submit" class="btn">Cadastrar Candidato</button>
            </form>
        </div>

        <div id="vagas" class="tab-content">
            <h2>Cadastrar Nova Vaga</h2>
            <form id="formVaga">
                <div class="form-row">
                    <div class="form-group"><label for="titulo">T√≠tulo da Vaga *</label><input type="text" id="titulo" name="titulo" required placeholder="Ex: Motorista de Caminh√£o"></div>
                    <div class="form-group"><label for="cidadeVaga">Cidade *</label><input type="text" id="cidadeVaga" name="cidade" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="tipo_contrato">Tipo de Contrato</label><select id="tipo_contrato" name="tipo_contrato"><option value="">Selecione...</option><option value="CLT">CLT</option><option value="PJ">PJ</option><option value="Tempor√°rio">Tempor√°rio</option><option value="Est√°gio">Est√°gio</option></select></div>
                    <div class="form-group"><label for="experiencia_min_anos">Experi√™ncia M√≠nima (anos)</label><input type="number" id="experiencia_min_anos" name="experiencia_min_anos" min="0" max="20" value="0"></div>
                </div>
                <div class="form-group"><label for="descricao">Descri√ß√£o da Vaga</label><textarea id="descricao" name="descricao" placeholder="Descreva as principais atividades..."></textarea></div>
                <div class="form-group"><label for="beneficios">Benef√≠cios</label><textarea id="beneficios" name="beneficios" placeholder="Ex: Vale transporte, vale refei√ß√£o..."></textarea></div>
                <button type="submit" class="btn">Cadastrar Vaga</button>
            </form>
        </div>

        <div id="buscar" class="tab-content">
            <h2>Buscar Candidatos por Vaga</h2>
            <div class="form-group"><label for="selectVaga">Selecione uma Vaga</label><select id="selectVaga"><option value="">Carregando vagas...</option></select></div>
            <button onclick="buscarCandidatos()" class="btn">Buscar Candidatos</button>
            <button onclick="exportarCSV()" class="btn btn-secondary">Exportar CSV</button>
            <div id="loadingBusca" class="loading"><div class="spinner"></div><p>Buscando candidatos...</p></div>
            <div id="resultadosBusca"></div>
        </div>

        <div id="resultados" class="tab-content">
            <h2>Todos os Candidatos</h2>
            <div class="form-row">
                <div class="form-group"><label for="filtroNome">Filtrar por Nome</label><input type="text" id="filtroNome" oninput="filtrarTodosCandidatos()" placeholder="Digite o nome..."></div>
                <div class="form-group"><label for="filtroCidade">Filtrar por Cidade</label><input type="text" id="filtroCidade" oninput="filtrarTodosCandidatos()" placeholder="Digite a cidade..."></div>
            </div>
            <button onclick="exportarTodosCSV()" class="btn btn-secondary">Exportar Todos</button>
            <div id="loadingTodos" class="loading"><div class="spinner"></div><p>Carregando candidatos...</p></div>
            <div id="listaTodosCandidatos"></div>
        </div>
    </div>

    <div id="modalCandidato" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <div id="conteudoModal"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            alert('ERRO: Configure as vari√°veis SUPABASE_URL e SUPABASE_ANON_KEY no c√≥digo antes de usar.');
        }

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let candidatosBusca = [];
        let todosOsCandidatos = [];

        function mostrarAlerta(mensagem, tipo = 'success') {
            const container = document.getElementById('alert-container');
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensagem;
            
            // Adiciona o alerta no container e aplica a classe 'show'
            container.appendChild(alerta);
            setTimeout(() => alerta.classList.add('show'), 10);

            // Remove o alerta ap√≥s 5 segundos
            setTimeout(() => {
                alerta.classList.remove('show');
                setTimeout(() => alerta.remove(), 300); // Remove do DOM ap√≥s a transi√ß√£o
            }, 5000);
        }

        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            element.classList.add('active');

            if (tabName === 'buscar') carregarVagas();
            if (tabName === 'resultados') carregarTodosCandidatos();
        }

        // --- FORMUL√ÅRIO DE CANDIDATO ---
        document.getElementById('formCandidato').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const curriculoFile = formData.get('curriculo');

            if (curriculoFile && curriculoFile.size > 10 * 1024 * 1024) {
                return mostrarAlerta('Arquivo muito grande. M√°ximo 10MB.', 'error');
            }

            try {
                const candidatoData = Object.fromEntries(formData.entries());
                candidatoData.skills = candidatoData.skills ? candidatoData.skills.split(',').map(s => s.trim()) : [];
                delete candidatoData.curriculo; // Remove o campo do arquivo

                // 1. Fazer upload do curr√≠culo, se existir
                if (curriculoFile && curriculoFile.name) {
                    const filePath = `public/${Date.now()}_${curriculoFile.name}`;
                    const { error: uploadError } = await supabase.storage
                        .from('curriculos')
                        .upload(filePath, curriculoFile);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage.from('curriculos').getPublicUrl(filePath);
                    candidatoData.curriculo_url = urlData.publicUrl;
                }

                // 2. Inserir os dados do candidato no banco
                const { error } = await supabase.from('candidatos').insert([candidatoData]);
                if (error) throw error;
                
                mostrarAlerta('Candidato cadastrado com sucesso!');
                form.reset();
                document.querySelector('.file-upload-label').textContent = 'Clique para selecionar o arquivo';
                atualizarEstatisticas();

            } catch (error) {
                console.error('Erro ao cadastrar candidato:', error);
                const message = error.message.includes('duplicate key')
                    ? 'Telefone ou e-mail j√° cadastrado.'
                    : 'Erro ao cadastrar candidato.';
                mostrarAlerta(message, 'error');
            }
        });
        
        // --- FORMUL√ÅRIO DE VAGA (CORRIGIDO) ---
        document.getElementById('formVaga').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const vagaData = Object.fromEntries(formData.entries());

            // Garante que a experi√™ncia seja um n√∫mero
            vagaData.experiencia_min_anos = parseInt(vagaData.experiencia_min_anos, 10) || 0;

            try {
                const { error } = await supabase.from('vagas').insert([vagaData]);
                if (error) throw error;

                mostrarAlerta('Vaga cadastrada com sucesso!');
                form.reset();
                atualizarEstatisticas();
                carregarVagas(); // Atualiza a lista de vagas na aba de busca

            } catch (error) {
                console.error('Erro ao cadastrar vaga:', error);
                mostrarAlerta('Erro ao cadastrar vaga.', 'error');
            }
        });

        async function carregarVagas() {
            const select = document.getElementById('selectVaga');
            try {
                const { data, error } = await supabase
                    .from('vagas')
                    .select('id, titulo, cidade')
                    .eq('status', 'aberta')
                    .order('data_criacao', { ascending: false });

                if (error) throw error;

                select.innerHTML = '<option value="">Selecione uma vaga...</option>';
                data.forEach(vaga => {
                    const option = document.createElement('option');
                    option.value = vaga.id;
                    option.textContent = `${vaga.titulo} - ${vaga.cidade}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar vagas:', error);
                select.innerHTML = '<option value="">Erro ao carregar vagas</option>';
            }
        }

        async function buscarCandidatos() {
            const vagaId = document.getElementById('selectVaga').value;
            if (!vagaId) return mostrarAlerta('Selecione uma vaga primeiro.', 'error');

            document.getElementById('loadingBusca').style.display = 'block';
            document.getElementById('resultadosBusca').innerHTML = '';

            try {
                // Aqui usamos a fun√ß√£o RPC criada no Supabase
                const { data, error } = await supabase.rpc('buscar_candidatos_compativeis', { id_vaga: vagaId });
                if (error) throw error;

                candidatosBusca = data;
                exibirCandidatos(data, 'resultadosBusca');
            } catch (error) {
                console.error('Erro na busca:', error);
                mostrarAlerta('Erro ao buscar candidatos.', 'error');
            } finally {
                document.getElementById('loadingBusca').style.display = 'none';
            }
        }

        async function carregarTodosCandidatos() {
            document.getElementById('loadingTodos').style.display = 'block';
            document.getElementById('listaTodosCandidatos').innerHTML = '';

            try {
                const { data, error } = await supabase.from('candidatos').select('*').order('data_cadastro', { ascending: false });
                if (error) throw error;
                todosOsCandidatos = data;
                exibirCandidatos(data, 'listaTodosCandidatos');
            } catch (error) {
                console.error('Erro ao carregar todos os candidatos:', error);
                mostrarAlerta('Erro ao carregar candidatos.', 'error');
            } finally {
                document.getElementById('loadingTodos').style.display = 'none';
            }
        }

        function exibirCandidatos(candidatos, containerId) {
            const container = document.getElementById(containerId);
            if (candidatos.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px;">Nenhum candidato encontrado.</p>';
                return;
            }

            container.innerHTML = candidatos.map(c => `
                <div class="candidato-card" data-id="${c.id}" data-nome="${c.nome}" data-cidade="${c.cidade}">
                    <div class="candidato-header">
                        <div class="candidato-nome">${c.nome}</div>
                        ${c.score !== undefined ? `<div class="score-badge">Score: ${c.score}</div>` : ''}
                    </div>
                    <div class="candidato-info">
                        <div class="info-item"><span class="info-label">Telefone:</span> ${c.telefone}</div>
                        <div class="info-item"><span class="info-label">Cidade:</span> ${c.cidade}</div>
                        <div class="info-item"><span class="info-label">Cargo:</span> ${c.cargo_desejado}</div>
                        <div class="info-item"><span class="info-label">Experi√™ncia:</span> ${c.experiencia_anos ?? 'N/A'} anos</div>
                    </div>
                    <div>
                        <button onclick="verDetalhes('${c.id}')" class="btn btn-secondary">Ver Detalhes</button>
                        ${c.curriculo_url ? `<a href="${c.curriculo_url}" target="_blank" class="btn">Baixar Curr√≠culo</a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function verDetalhes(candidatoId) {
            try {
                const { data, error } = await supabase.from('candidatos').select('*').eq('id', candidatoId).single();
                if (error) throw error;

                document.getElementById('conteudoModal').innerHTML = `
                    <h2>${data.nome}</h2>
                    <p><strong>Telefone:</strong> ${data.telefone}</p>
                    <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                    <p><strong>Cidade:</strong> ${data.cidade}</p>
                    <p><strong>Cargo Desejado:</strong> ${data.cargo_desejado}</p>
                    <p><strong>Experi√™ncia:</strong> ${data.experiencia_anos ?? 'N/A'} anos</p>
                    <p><strong>Disponibilidade:</strong> ${data.disponibilidade || 'N/A'}</p>
                    <p><strong>Habilidades:</strong> ${data.skills ? data.skills.join(', ') : 'N/A'}</p>
                    <p><strong>Observa√ß√µes:</strong> ${data.observacoes || 'N/A'}</p>
                    <p><strong>Cadastrado em:</strong> ${new Date(data.data_cadastro).toLocaleDateString('pt-BR')}</p>
                    ${data.curriculo_url ? `<br><a href="${data.curriculo_url}" target="_blank" class="btn">Baixar Curr√≠culo</a>` : ''}
                `;
                document.getElementById('modalCandidato').classList.add('show');
            } catch (error) {
                mostrarAlerta('Erro ao carregar detalhes do candidato.', 'error');
            }
        }

        function fecharModal() {
            document.getElementById('modalCandidato').classList.remove('show');
        }

        function gerarCSV(candidatos) {
            const headers = ['Nome', 'Telefone', 'Email', 'Cidade', 'Cargo Desejado', 'Experiencia (Anos)', 'Disponibilidade', 'Habilidades', 'Score'];
            const rows = candidatos.map(c => [
                `"${c.nome}"`, `"${c.telefone}"`, `"${c.email || ''}"`, `"${c.cidade}"`,
                `"${c.cargo_desejado}"`, c.experiencia_anos || '', `"${c.disponibilidade || ''}"`,
                `"${c.skills ? c.skills.join('; ') : ''}"`, c.score || ''
            ].join(','));
            return [headers.join(','), ...rows].join('\n');
        }

        function baixarCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportarCSV() {
            if (candidatosBusca.length === 0) return mostrarAlerta('Nenhum candidato na busca para exportar.', 'error');
            const csv = gerarCSV(candidatosBusca);
            baixarCSV(csv, 'candidatos_selecionados.csv');
        }
        
        async function exportarTodosCSV() {
            if (todosOsCandidatos.length === 0) return mostrarAlerta('N√£o h√° candidatos para exportar.', 'error');
            const csv = gerarCSV(todosOsCandidatos);
            baixarCSV(csv, 'todos_os_candidatos.csv');
        }

        async function atualizarEstatisticas() {
            try {
                const { count: totalCandidatos, error: errCandidatos } = await supabase.from('candidatos').select('*', { count: 'exact', head: true });
                if(errCandidatos) throw errCandidatos;
                document.getElementById('totalCandidatos').textContent = totalCandidatos;
                
                const { count: totalVagas, error: errVagas } = await supabase.from('vagas').select('*', { count: 'exact', head: true }).eq('status', 'aberta');
                if(errVagas) throw errVagas;
                document.getElementById('totalVagas').textContent = totalVagas;

                const hoje = new Date().toISOString().slice(0, 10);
                const { count: candidatosHoje, error: errHoje } = await supabase.from('candidatos').select('*', { count: 'exact', head: true }).gte('data_cadastro', hoje);
                if(errHoje) throw errHoje;
                document.getElementById('candidatosHoje').textContent = candidatosHoje;

            } catch (error) {
                console.error('Erro ao atualizar estat√≠sticas:', error);
            }
        }

        function filtrarTodosCandidatos() {
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroCidade = document.getElementById('filtroCidade').value.toLowerCase();
            const cards = document.querySelectorAll('#listaTodosCandidatos .candidato-card');
            cards.forEach(card => {
                const nome = card.dataset.nome.toLowerCase();
                const cidade = card.dataset.cidade.toLowerCase();
                const show = nome.includes(filtroNome) && cidade.includes(filtroCidade);
                card.style.display = show ? 'block' : 'none';
            });
        }

        // --- INICIALIZA√á√ÉO E LISTENERS GERAIS ---
        document.getElementById('curriculo').addEventListener('change', (e) => {
            const label = document.querySelector('.file-upload-label');
            label.textContent = e.target.files.length > 0 ? e.target.files[0].name : 'Clique para selecionar o arquivo';
        });

        window.onclick = (event) => {
            if (event.target == document.getElementById('modalCandidato')) {
                fecharModal();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            atualizarEstatisticas();
            // Inicia na primeira aba
            showTab('candidatos', document.querySelector('.tab-button.active'));
        });
    </script>
</body>
</html>
